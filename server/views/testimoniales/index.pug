extends ../layout/index

//- Schema.org markup para SEO
block append head
    if testimoniales && testimoniales.length > 0
        script(type="application/ld+json").
            {
                "@context": "https://schema.org",
                "@type": "LocalBusiness",
                "name": "Agencia de Viajes Escápate Conmigo",
                "description": "Agencia de viajes especializada en experiencias únicas y memorables",
                "url": "#{process.env.SITE_URL || 'https://tuagencia.com'}",
                "telephone": "+52 (81) 1696-1590",
                "address": {
                    "@type": "PostalAddress",
                    "addressLocality": "Monterrey",
                    "addressRegion": "Nuevo León",
                    "addressCountry": "MX"
                },
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": "5",
                    "reviewCount": "#{totalTestimoniales || testimoniales.length}"
                },
                "review": [
                    #{testimoniales.slice(0, 10).map(t => `{
                        "@type": "Review",
                        "author": {
                            "@type": "Person",
                            "name": "${t.nombre.replace(/"/g, '\\"')}"
                        },
                        "datePublished": "${t.createdAt ? new Date(t.createdAt).toISOString() : new Date().toISOString()}",
                        "reviewBody": "${t.mensaje.replace(/"/g, '\\"').replace(/\n/g, ' ')}",
                        "reviewRating": {
                            "@type": "Rating",
                            "ratingValue": "5",
                            "bestRating": "5"
                        }
                    }`).join(',')}
                ]
            }

block contenido
    .container.mt-5
        h1.text-center.mb-5 #{pagina}
        .row
            .col-md-12
                if exito
                    .alert.alert-success.alert-dismissible.fade.show.text-center(role="alert")
                        i.fas.fa-check-circle.mr-2(aria-hidden="true")
                        strong ¡Gracias por tu testimonial!
                        span Tu mensaje ha sido publicado exitosamente.
                        button.close(type="button", data-dismiss="alert", aria-label="Cerrar")
                            span(aria-hidden="true") &times;
                include ../layout/partials/testimoniales

                //- Paginación
                if totalPages > 1
                    nav.mt-4(aria-label="Navegación de testimoniales")
                        ul.pagination.justify-content-center
                            //- Botón anterior
                            li.page-item(class=!hasPrevPage ? 'disabled' : '')
                                if hasPrevPage
                                    a.page-link(href=`/testimoniales?page=${currentPage - 1}`, aria-label="Página anterior")
                                        i.fas.fa-chevron-left(aria-hidden="true")
                                        span.sr-only Anterior
                                else
                                    span.page-link
                                        i.fas.fa-chevron-left(aria-hidden="true")
                                        span.sr-only Anterior

                            //- Páginas numeradas con puntos suspensivos
                            - const maxVisiblePages = 5;
                            - const halfVisible = Math.floor(maxVisiblePages / 2);
                            - let startPage = Math.max(1, currentPage - halfVisible);
                            - let endPage = Math.min(totalPages, currentPage + halfVisible);

                            //- Ajustar si estamos cerca del inicio o final
                            - if (currentPage <= halfVisible) {
                            -     endPage = Math.min(totalPages, maxVisiblePages);
                            - }
                            - if (currentPage > totalPages - halfVisible) {
                            -     startPage = Math.max(1, totalPages - maxVisiblePages + 1);
                            - }

                            //- Primera página si no está visible
                            if startPage > 1
                                li.page-item
                                    a.page-link(href="/testimoniales?page=1") 1
                                if startPage > 2
                                    li.page-item.disabled
                                        span.page-link ...

                            //- Páginas visibles
                            - for (let i = startPage; i <= endPage; i++)
                                li.page-item(class=currentPage === i ? 'active' : '')
                                    a.page-link(href=`/testimoniales?page=${i}`)= i
                                    if currentPage === i
                                        span.sr-only (página actual)

                            //- Última página si no está visible
                            if endPage < totalPages
                                if endPage < totalPages - 1
                                    li.page-item.disabled
                                        span.page-link ...
                                li.page-item
                                    a.page-link(href=`/testimoniales?page=${totalPages}`)= totalPages

                            //- Botón siguiente
                            li.page-item(class=!hasNextPage ? 'disabled' : '')
                                if hasNextPage
                                    a.page-link(href=`/testimoniales?page=${currentPage + 1}`, aria-label="Página siguiente")
                                        i.fas.fa-chevron-right(aria-hidden="true")
                                        span.sr-only Siguiente
                                else
                                    span.page-link
                                        i.fas.fa-chevron-right(aria-hidden="true")
                                        span.sr-only Siguiente

                        //- Información de página actual
                        p.text-center.text-muted.mt-3
                            small Mostrando #{(currentPage - 1) * 12 + 1} - #{Math.min(currentPage * 12, totalTestimoniales)} de #{totalTestimoniales} testimoniales

            .col-md-12.mt-5
                h2#form-heading.text-center Agrega un Testimonial
                if(errores)
                    .alert-container(role="alert", aria-live="polite")
                        each error in errores
                            .alert.alert-danger.text-center(role="alert")
                                i.fas.fa-exclamation-circle.mr-2(aria-hidden="true")
                                span= error.mensaje
                .row.justify-content-center
                    .col-md-8
                        form(
                            action="/testimoniales",
                            method="POST",
                            aria-labelledby="form-heading",
                            novalidate
                        )
                            .form-group
                                label(for="nombre")
                                    | Nombre
                                    span.text-danger(aria-label="campo requerido") *
                                input(
                                    id="nombre",
                                    class="form-control",
                                    type="text",
                                    placeholder="Tu Nombre",
                                    name="nombre",
                                    value=nombre,
                                    required,
                                    minlength="2",
                                    maxlength="100",
                                    aria-required="true",
                                    aria-describedby="nombre-help"
                                )
                                small#nombre-help.form-text.text-muted Entre 2 y 100 caracteres
                            .form-group
                                label(for="correo")
                                    | Correo Electrónico
                                    span.text-danger(aria-label="campo requerido") *
                                input(
                                    id="correo",
                                    class="form-control",
                                    type="email",
                                    placeholder="correo@ejemplo.com",
                                    name="correo",
                                    value=correo,
                                    required,
                                    aria-required="true",
                                    aria-describedby="correo-help"
                                )
                                small#correo-help.form-text.text-muted Tu correo no será compartido
                            .form-group
                                label(for="mensaje")
                                    | Mensaje
                                    span.text-danger(aria-label="campo requerido") *
                                textarea(
                                    id="mensaje",
                                    class="form-control",
                                    name="mensaje",
                                    rows="5",
                                    placeholder="Cuéntanos sobre tu experiencia...",
                                    required,
                                    minlength="10",
                                    maxlength="500",
                                    aria-required="true",
                                    aria-describedby="mensaje-help mensaje-counter"
                                )= mensaje
                                .d-flex.justify-content-between.align-items-center
                                    small#mensaje-help.form-text.text-muted Entre 10 y 500 caracteres
                                    small#mensaje-counter.form-text.text-muted
                                        span#char-count 0
                                        | /500
                            button.btn.btn-success.btn-block.btn-lg(
                                type="submit",
                                aria-label="Enviar testimonial"
                            )
                                i.fas.fa-paper-plane.mr-2(aria-hidden="true")
                                | Enviar Testimonial